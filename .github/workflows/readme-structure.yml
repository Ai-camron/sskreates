name: README structure

on:
  push:
    branches:
      - main
  pull_request:

defaults:
  run:
    shell: bash

permissions:
  statuses: write

jobs:
  readme-structure:
    name: tests/readme_structure
    runs-on: ubuntu-latest
    steps:
      - name: Set pending status
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.payload.pull_request?.head.sha ?? context.sha;
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha,
              state: 'pending',
              context: 'tests/readme_structure',
              description: 'README structure test is running.'
            });
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run README structure test
        id: readme-test
        run: tests/readme_structure.test.sh
      - name: Update commit status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const outcome = '${{ steps.readme-test.outcome }}';
            const sha = context.payload.pull_request?.head.sha ?? context.sha;
            const state = outcome === 'success' ? 'success' : 'failure';
            const description = outcome === 'success'
              ? 'README structure test passed.'
              : 'README structure test failed.';
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha,
              state,
              context: 'tests/readme_structure',
              description
            });
      - name: Fail if README structure test failed
        if: steps.readme-test.outcome != 'success'
        run: |
          echo 'README structure test failed.' >&2
          exit 1
